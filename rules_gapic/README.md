## GAPIC Generator [Bazel](https://www.bazel.build/) Integration 

### Requirements

- Bazel version `0.16.0+` (with `--experimental_enable_repo_mapping` turned on).
- Linux (may work on other platforms, but this haven't been tested).

### Usage

The rules will call `gapic-generator` and do all the necessary pre- and post- generation steps to generate a fully-functional client library for a specified service API in a specified language (currently only `Java` is supported). The rules are expected to be used from within a Bazel workspace containing service interface definitions in one of the following formats: 
- **`proto/grpc`** format, defined by `<service>.proto`, `<service>.yaml` and `<service>_gapic.yaml` files; see [googleapis](https://github.com/googleapis/googleapis) repository for an example.
- **`discovery/httpjson`** format, defined by `<service>.json` and `<service>_gapic.yaml`; see [discovery-artifact-manager](https://github.com/googleapis/discovery-artifact-manager) repository for an example. 

### Rules and Macros

#### Cross-language
1. **`gapic_srcjar`** - cross-language (main) **rule** which calls gapic-generator, supplies necessary input files to it (like `gapic_<service>.yaml`, `<service>.yaml` or `discovery_doc.json` in case of discogapic generation). Notice that `artman_<service>.yaml` (googleapis), `dependencies.yaml` and `api_defaults.yaml` (gapic-generator) and `package_yaml2` (generated by artman from artman and service yamls) become obsolete (not required at any stage). The chosen name tries to follow Bazel best practices, in which a rule name must be a noun, which represents the output of the rule.
2. **`proto_custom_library`** - cross-language **rule**, which allows: 1) calling `protoc` with custom plugins; 2) specifying the output files format and file extension (essential for consuming (down the chain) rules); 3) accepting `proto_library` targets as inputs (to adhere to Bazel protobuf best practices and stay consistent with everything else). Unfortunately Bazel does not have native support for the features above and a similar rule in protobuf repo [proto_gen](https://github.com/protocolbuffers/protobuf/blob/master/protobuf.bzl#L173) satisfies the 1st requirement/feature but not the other two.  Notice that this rule does not replace `proto_library`, it is additive to it (it uses `proto_library`'s output as input, while `proto_library` has raw proto files as input).
3. **`proto_library_with_info`** - cross-language **macro**, which wraps `proto_custom_library` and provides "fat" proto descriptor. This is not supported by native `proto_library` rule but is required by gapic-generator to include documentation from protos and to overcome the limitation of "only one" desc file as an input in gapic-generator (dependencies' proto descriptors must be supplied somehow, here they are embedded in one big descriptor which then goes to gapic-gen as input).

#### Java
1. **`java_gapic_srcjar`** - java **rule**, which does all the java-specific post-processing of the java gapic-generator output (produced by `gapic_srcjar` rule). This includes running formatter and splitting output into main and test packages (a design decision/assumption made, but it is essential (though not strictly required) for proper building of the artifacts within Bazel).
2. **`java_gapic_library`** - java **macro**, which subsequently calls `gapic_srcjar` to generate sources, then `java_gapic_srcjar` to post-process them, then  native `java_library` (twice, one for main and one for tests) to build java binary lib from the generated output within Bazel. This is **the rule**, which intends to put gapic-generator on same level of tools integration as protoc (`java_proto_library`) and grpc (`java_grpc_library`).
3. **`java_discogapic_library`** - java **macro**, which is very similar to `java_gapic_library` and does same, but for discogapic libraries.
4. **`java_resource_name_proto_library`** - java **macro**, which uses `proto_custom_library` and `java_library` rules to generate resource names sources and then calls `java_library` to build the corresponding library from the generated sources. Notice that resource names can be generated and compiled as a standalone library (do not have to be  a part of `proto-<service>` library).
5. **`java_gapic_build_configs_pkg`** - java **rule**, which is responsible for generating (from templates) build-specific resources for third_party build systems (like gradle). For example it is used to generate `build.gradle` and `settings.gradle` from templates. 
6. **`java_gapic_srcs_pkg`** - java **rule**, which organizes generated sources in a "custom" form (expected/defined by third_party build system package, typically gradle or maven).
7. **gradle**-specific rules and macros (to build idiomatic package ready for opensourcing and independent from Bazel):
    1. **`_java_gapic_gradle_pkg`** - **private** java **rule**, used by most other `java*_pkg` (see below) macros to package stuff (i.e. generate artman-like output).
    2. **`java_gapic_proto_gradle_pkg`** - java **macro**, which accepts previously built `java_library` (proto classes, and, optionally, resource names classes) and uses other rules to generate java `proto-google-cloud-<service>` packages (identical to the output provided by artman, archived in `.tar.gz` format). The `.tar.gz` format is chosen because it allows to reuse existing `pkg_tar` Bazel rule (unfortunately Bazel does not have native support for packaging into `.zip` yet).
    3. **`java_gapic_grpc_gradle_pkg`** - java **macro**, which accepts previously built `java_library` (grpc classes) and uses other rules to generate java `grpc-google-cloud-<service>` packages (identical to the output provided by artman, archived in `.tar.gz` format).
    4. **`java_gapic_gradle_pkg`** - java **macro**, which accepts previously built `java_library` (gapic classes) uses other rules to generate java `gapic-google-cloud-<service>` packages (identical to the output provided by artman, archived in `.tar.gz` format).
    5. **`java_gapic_assembly_gradle_pkg`** - java **macro**, which accept other `*_pkg` targets as input and generates complete self-contained assembly of java clients (identical to the output of batch generation in artman, archived in `.tar.gz` format). The assembly then can be built (this time by a third_party tool `gradle` (not `bazel` itself)) by simply calling `./gradlew clean test`.

### Generated Artifacts Dependencies Resolution
#### Java
1. **`java/java_gapic_pkg_repos.bzl`** - this file essentially replaces `artman_<service>.yaml`, `dependencies.yaml` and `api_defaults.yaml` by using `bazel` itself for dependencies resolution. Previously the dependencies were handled in a form of yaml config values, when they are not validated to: 1) be correct/exist; 2) match generated code; 3) be sufficient/redundant. To deal with dependencies versions mismatch, the `repo_mapping` feature of Bazel is supposed to be used (enabled by `--experimental_enable_repo_mapping` command line argument).
